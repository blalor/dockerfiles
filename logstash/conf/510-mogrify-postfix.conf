filter {
    ## postfix/anvil
    ## postfix/cleanup
    ## postfix/local
    ## postfix/master
    ## postfix/pickup
    ## postfix/postfix-script
    ## postfix/qmgr
    ## postfix/smtp
    ## postfix/smtpd
    
    if [type] == "syslog" and [program] =~ /^postfix\// {
        ## pull in the queue id
        grok {
            patterns_dir => [ "/etc/logstash/patterns/" ]
            
            match => {
                "message" => "(%{POSTFIX_QUEUEID:queue_id}: )?%{GREEDYDATA:message}"
            }
            
            overwrite => "message"
        }
        
        kv {
            field_split => ", "
        }
        
        mutate {
            ## consistent naming of message ID fields
            ## a dash in the capture name is illegal in Oniguruma
            rename => { 
                "message-id" => "message_id"
            }
            
            ## remove brackets from various fields
            gsub => [
                ## not sure rename will happen before gsub
                "message-id", "[<>]", "",
                "message_id", "[<>]", "",
                
                "from", "[<>]", "",
                "to", "[<>]", "",
                "orig_to", "[<>]", ""
            ]

            ## strings to numbers
            convert => [
                "delay", "float",
                "nrcpt", "integer",
                "pid", "integer",
                "size", "integer"
            ]
        }
    }
}
